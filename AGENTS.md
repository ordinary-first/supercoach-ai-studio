# Secret Coach AI Studio ??Agent Context

## Project Overview
- **Stack**: React 19 + Vite 6 + TypeScript (SPA)
- **State**: Zustand (no Redux)
- **Auth**: Firebase Auth (Google signInWithPopup)
- **DB**: Firestore (cloud) + localStorage (offline)
- **AI**: OpenAI (Responses API + gpt-image + TTS + Sora)
- **Deploy**: Vercel (https://web-legacy-ruddy.vercel.app/)
- **Firebase**: project `coach-52bf4`
- **Package Manager**: npm (lock file exists)

## Architecture

### Data Flow
- Dual-write: always localStorage + Firestore for non-guest users
- `isGuestUser(uid?)` gates Firestore access ??guest users skip cloud entirely
- Timestamp-based conflict resolution (`updatedAt`) on load
- Auto-save triggers on data change

### Key Files
| File | Role |
|------|------|
| `App.tsx` | Main orchestrator, data loading, auto-save |
| `services/firebaseService.ts` | Auth, Firestore CRUD, sync status |
| `services/aiService.ts` | AI API integration |
| `components/MindMap.tsx` | D3 force-directed goal graph |
| `components/CoachChat.tsx` | AI coaching chat |
| `components/ToDoList.tsx` | Todo management |
| `components/CalendarView.tsx` | Calendar view |
| `components/LandingPage.tsx` | Login page |
| `components/UserProfilePage.tsx` | User profile |
| `stores/` | Zustand stores |
| `hooks/` | Custom React hooks |
| `types.ts` | Shared TypeScript types |
| `vite.config.ts` | Build config, env var injection |
| `capacitor.config.json` | Capacitor app config (`webDir=dist`) |
| `android/` | Native Android project generated by Capacitor |

### Build
```bash
npm run dev      # Dev server
npm run build    # Production build
npm run preview  # Preview production build
npm run build:cap # Build + Capacitor sync
npm run cap:open:android # Open Android Studio project
```

## Coding Rules

### Must Follow
- Functional components only (no class components)
- Zustand for state (no Redux)
- No `any` type (minimize `unknown` too)
- No `console.log` (use proper logger)
- No hardcoded API keys (use env vars)
- Named exports preferred (minimize default export)
- Early return pattern
- Max line length: 100 chars
- Max function length: 50 lines
- Max file length: 300 lines

### Style
- Components: PascalCase (`UserProfile.tsx`)
- Hooks: camelCase + `use` prefix (`useAuth.ts`)
- Utils: camelCase (`formatDate.ts`)
- Constants: UPPER_SNAKE_CASE (`API_BASE_URL`)
- Folders: kebab-case (`user-profile/`)

### Version Bumping
Every code change MUST bump `displayVersion` in `package.json`.
Format: `V{MM}.{DD}r{revision}` ??e.g. `V02.13r01` = Feb 13, 1st revision.
Same-day changes increment revision (r2, r3...). New day resets to r1.

## Agent Handoff Protocol

When one agent completes work that another agent will continue:
1. Update this file's "Current Status" section below
2. List what was done and what remains
3. Note any gotchas or decisions made

## Current Status
_Last updated: 2026-02-16_
- Localized mind-map action bar by app language (`ko`/`en`) via `language` prop wiring (`App.tsx`, `components/MindMap.tsx`)
- Repositioned action bar to avoid node overlap by anchoring near node bounds (prefer top, fallback bottom near header) (`components/MindMap.tsx`)
- Bumped `displayVersion` to `V02.16r11` (`package.json`)
- Fixed mojibake/깨진 한글 in Visualization view UI text (`components/VisualizationModal.tsx`)
- Bumped `displayVersion` to `V02.16r10` (`package.json`)
- Locked mobile browser zoom only on GOALS tab so header/bottom dock stay fixed:
  - Added viewport meta lock/unlock effect in `App.tsx` for coarse pointer + GOALS tab only
  - Lock content: `user-scalable=no, maximum-scale=1, minimum-scale=1`
- Added map-container native gesture guards in `components/MindMap.tsx`:
  - Prevent default on multi-touch (`touchstart`/`touchmove` with 2+ touches)
  - Prevent default on iOS gesture events (`gesturestart`/`gesturechange`/`gestureend`)
- Bumped `displayVersion` to `V02.16r09` (`package.json`)
- Fixed mobile pinch zoom reliability in mind map:
  - Registered `TouchEvent` plugin for `simple-mind-map` (`components/MindMap.tsx`)
  - Expanded zoom-out floor (`minZoomRatio`/`minTouchZoomScale` to 5%)
  - Added `touchAction: 'none'` on map container to reduce gesture conflicts
- Bumped `displayVersion` to `V02.16r08` (`package.json`)
- Replaced mind-map long-press/right-click context menu with single-tap action bar (`components/MindMap.tsx`)
- Added node action bar policy by node type:
  - Non-root: `Child`, `Sibling`, `Todo`, `Generate` + `More(Insert image, Delete)`
  - Root: `Child`, `Generate`, `Insert` only
- Kept text edit entry on double-click/double-tap and wired through App edit state (`components/MindMap.tsx`, `App.tsx`)
- Added node image insert upload flow:
  - Client: hidden file input + upload handler (`App.tsx`, `services/aiService.ts`)
  - API: `POST /api/upload-node-image` with 400x400 JPEG compression and R2 upload fallback (`api/upload-node-image.ts`)
- Bumped `displayVersion` to `V02.16r07` (`package.json`)
- Image generation policy split by use-case:
  - Mind map node image: `gpt-image-1-mini` + `low` (`api/generate-image.ts`, `services/aiService.ts`)
  - Visualization image: `gpt-image-1.5` + default `medium`, optional `high` (`api/generate-image.ts`, `components/VisualizationModal.tsx`)
- Added visualization image quality toggle UI (Medium/High) (`components/VisualizationModal.tsx`)
- Bumped `displayVersion` to `V02.16r06` (`package.json`)
- Migrated AI serverless routes from Gemini to OpenAI:
  - Chat: Responses API + function tools (`api/chat.ts`)
  - Narrative: Responses API (`api/generate-narrative.ts`)
  - Images: `gpt-image-1.5` generate/edit (`api/generate-image.ts`)
  - Speech: `gpt-4o-mini-tts` PCM16 output (`api/generate-speech.ts`)
  - Video: `sora-2` job + polling (`api/generate-video.ts`, `services/aiService.ts`)
- Fixed cross-account data bleed: force reload per uid and reset in-memory state on uid change (`hooks/useAuth.ts`, `App.tsx`)
- Fixed cross-account data bleed in Visualization gallery: localStorage key is now uid-scoped + legacy key migration (`components/VisualizationModal.tsx`)
- Hardened Google login account switching: sign out before `signInWithPopup` to avoid reusing prior Firebase session (`services/firebaseService.ts`)
- Fixed account switch race: derive uid from auth callback payload (`hooks/useAuth.ts`)
- Added admin wipe script to reset Firestore goals/todos for all Auth users (`scripts/wipe-user-data.mjs`)
- Bumped `displayVersion` to `V02.16r04` (`package.json`)
- Replaced top-right text button with icon-only settings trigger in App.tsx
- Added full-screen SettingsPage.tsx for settings navigation-style flow
- Added Polar compliance checklist UI in settings (digital-only / no human service / no donation / instant access)
- Added age-based checkout readiness guard (18+ only message before payment integration)
- Moved language selector (English / Korean) into Settings page
- Reflected selected language to document.documentElement.lang
- Fixed mobile long-press context menu sizing to follow mind-map zoom scale (`components/MindMap.tsx`)
- Hardened context menu scaling on mobile by reading current zoom scale at menu-open time (`components/MindMap.tsx`)
- Fixed mobile header layout: reduced "SECRET COACH" footprint and prevented version/settings overlap (`components/MindMap.tsx`, `App.tsx`)
- Fixed mojibake/깨진 한글 UI 텍스트 in App (loading, shortcuts, sync status, delete confirm) (`App.tsx`)
- Removed Chinese placeholder text on new node creation; quick-create now creates React node and enters edit immediately (`components/MindMap.tsx`)
- Added reusable pricing calculator for OpenAI migration:
  - `pricing/pricing-config.json` (all cost assumptions and tier limits)
  - `pricing/calc-pricing.mjs` (expected/worst margin simulation)
  - `pricing/README.md` (formula + tier differentiation guide)
- Added `api/polar-webhook.ts` endpoint (initial live receiver for selected Polar events)
- Added Polar checkout API route:
  - `api/create-checkout.ts` (plan -> product mapping, checkout session creation)
- Added client billing service:
  - `services/polarService.ts` (`createPolarCheckout`, `verifyPolarCheckout`)
- Updated `SettingsPage` to show 4 plans and start checkout directly.
- Fixed runtime hook-order issue in `SettingsPage` causing React minified error #310.
- Added checkout verification API:
  - `api/verify-checkout.ts` (server-side verification by checkout_id)
- Added auto verification in `App.tsx`:
  - reads `checkout_id` from success URL query
  - calls `verifyPolarCheckout`
  - shows success/error toast and cleans URL param
- Added Firebase Admin bootstrap:
  - `lib/firebaseAdmin.ts` (server-only Firestore admin initialization)
- Upgraded Polar webhook endpoint:
  - `api/polar-webhook.ts` now verifies Standard Webhooks signature
  - syncs billing/subscription state to Firestore (`users/{uid}/billing/polar`)
  - mirrors entitlement summary to profile (`users/{uid}/profile/main`)
- Fixed Vercel runtime for webhook:
  - `api/polar-webhook.ts` imports internal module with `.js` extension (ESM)
- Added custom domain redirect:
  - `vercel.json` redirects `www.secretcoach.ai/*` -> `secretcoach.ai/*`
- Improved Polar checkout error visibility:
  - `api/create-checkout.ts` now returns `polarDetail` on 4xx/5xx for debugging
- Added legal policy pages + links:
  - Public pages: `/terms`, `/privacy`, `/refund` (served from `public/`)
  - Linked from Settings (near checkout) and LandingPage
- Webhook signature verification hardening:
  - `api/polar-webhook.ts` now supports both plain and base64 secret verification paths
  - returns 403 with missing header hints for easier debugging
- Fixed Polar webhook 403 root cause:
  - `api/polar-webhook.ts` now verifies signatures against the raw request body (stream-first)
- Version: V02.16r11
- Remaining: iOS platform add/build must be done on macOS

