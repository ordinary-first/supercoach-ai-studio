# Secret Coach AI Studio ??Agent Context

## Project Overview
- **Stack**: React 19 + Vite 6 + TypeScript (SPA)
- **State**: Zustand (no Redux)
- **Auth**: Firebase Auth (Google signInWithPopup)
- **DB**: Firestore (metadata) + R2 (file assets)
- **AI**: OpenAI (Responses API + gpt-image + TTS + Sora)
- **Deploy**: Vercel (https://web-legacy-ruddy.vercel.app/)
- **Firebase**: project `coach-52bf4`
- **Package Manager**: npm (lock file exists)

## Architecture

### Data Flow
- Firebase Auth persistence keeps login across refreshes
- User data is backend-only (Firestore + R2), no app-level localStorage persistence
- Auto-save writes goals/todos/profile to Firestore
- Visualization save path uploads assets to R2 and stores metadata in Firestore

### Key Files
| File | Role |
|------|------|
| `App.tsx` | Main orchestrator, data loading, auto-save |
| `services/firebaseService.ts` | Auth, Firestore CRUD, sync status |
| `services/aiService.ts` | AI API integration |
| `components/MindMap.tsx` | D3 force-directed goal graph |
| `components/CoachChat.tsx` | AI coaching chat |
| `components/ToDoList.tsx` | Todo management |
| `components/CalendarView.tsx` | Calendar view |
| `components/LandingPage.tsx` | Login page |
| `components/UserProfilePage.tsx` | User profile |
| `stores/` | Zustand stores |
| `hooks/` | Custom React hooks |
| `types.ts` | Shared TypeScript types |
| `vite.config.ts` | Build config, env var injection |
| `capacitor.config.json` | Capacitor app config (`webDir=dist`) |
| `android/` | Native Android project generated by Capacitor |

### Build
```bash
npm run dev      # Dev server
npm run build    # Production build
npm run preview  # Preview production build
npm run build:cap # Build + Capacitor sync
npm run cap:open:android # Open Android Studio project
```

## Coding Rules

### Must Follow
- Functional components only (no class components)
- Zustand for state (no Redux)
- No `any` type (minimize `unknown` too)
- No `console.log` (use proper logger)
- No hardcoded API keys (use env vars)
- Named exports preferred (minimize default export)
- Early return pattern
- Max line length: 100 chars
- Max function length: 50 lines
- Max file length: 300 lines

### Style
- Components: PascalCase (`UserProfile.tsx`)
- Hooks: camelCase + `use` prefix (`useAuth.ts`)
- Utils: camelCase (`formatDate.ts`)
- Constants: UPPER_SNAKE_CASE (`API_BASE_URL`)
- Folders: kebab-case (`user-profile/`)

### Version Bumping
Every code change MUST bump `displayVersion` in `package.json`.
Format: `V{MM}.{DD}r{revision}` ??e.g. `V02.13r01` = Feb 13, 1st revision.
Same-day changes increment revision (r2, r3...). New day resets to r1.

## Agent Handoff Protocol

When one agent completes work that another agent will continue:
1. Update this file's "Current Status" section below
2. List what was done and what remains
3. Note any gotchas or decisions made

## Current Status
_Last updated: 2026-02-16_
- Visualization outage recovery r20 completed:
  - Switched visualization image/audio generation to R2-first URL flow (`api/generate-image.ts`, `api/generate-speech.ts`)
  - Standardized generate-image API response schema with `status/requestId/errorCode/errorMessage`
  - Added one-retry network policy for visualization media/video requests (`services/aiService.ts`)
  - Reduced video polling wait to 45s and return pending-friendly status on timeout (`services/aiService.ts`)
  - Updated visualization generation flow with per-request `generationId` and user-scoped API params (`components/VisualizationModal.tsx`)
  - Improved image failure message to include error code metadata in UI (`components/VisualizationModal.tsx`)
- Bumped `displayVersion` to `V02.16r20` (`package.json`)
- Visualization outage recovery v2 completed:
  - Added failure-code surfacing for TTS (`api/generate-speech.ts`) with structured success/failure schema
  - Normalized video API responses with explicit `errorCode/errorMessage/requestId` and removed silent-unknown paths (`api/generate-video.ts`)
  - Added hybrid save fallback API (`api/save-visualization.ts`) using Firebase Admin token verification
  - Extended Firebase Admin helper with `getAdminAuth()` for server-side auth verification (`lib/firebaseAdmin.ts`)
  - Upgraded client service result types for audio/video error propagation (`services/aiService.ts`)
  - Added `saveVisualizationViaApi` fallback helper (`services/firebaseService.ts`)
  - Rebuilt `components/VisualizationModal.tsx` in UTF-8 with per-step status chips, error-code messaging, and automatic save fallback
- Bumped `displayVersion` to `V02.16r19` (`package.json`)
- Fixed login-page Korean mojibake root cause:
  - `components/LandingPage.tsx` file encoding converted from CP949(ANSI) to UTF-8
  - Prevents garbled Korean text on built/deployed login screen
- Bumped `displayVersion` to `V02.16r18` (`package.json`)
- Stabilized visualization flow (`components/VisualizationModal.tsx`):
  - Video generation now uses 4s default duration via new object response path
  - Distinguishes video `pending` vs `failed` in UI
  - Allows partial save when video is still pending (image/text/audio save first)
  - Added pending video re-check action and one-shot auto-check on saved-item open
  - Reworked save payload normalization to avoid undefined fields in Firestore writes
- Extended video/save contracts:
  - `api/generate-video.ts` now clamps `durationSec` to 2..6 (default 4) and returns normalized payload
  - `services/aiService.ts` now returns `VideoGenerationResult` (status/videoId/videoUrl/durationSec)
  - `services/firebaseService.ts` supports `videoStatus`/`videoId` and adds sanitized partial update helper
- Bumped `displayVersion` to `V02.16r17` (`package.json`)
- Hardened visualization image generation fallback:
  - `api/generate-image.ts` now retries once with `gpt-image-1` when primary response is empty
  - Supports both `b64_json` and `url` paths before returning empty media
- Softened video-empty warning copy in visualization result to indicate queued generation state (`components/VisualizationModal.tsx`)
- Bumped `displayVersion` to `V02.16r16` (`package.json`)
- Fixed profile-page Korean mojibake risk by normalizing `components/UserProfilePage.tsx` to UTF-8 encoding
- Bumped `displayVersion` to `V02.16r15` (`package.json`)
- Removed app-level localStorage dependency for user data:
  - Language preference now loads/saves via Firestore settings (`App.tsx`, `services/firebaseService.ts`)
  - MindMap action-bar language fallback now uses `language` prop + `document.lang` only (`components/MindMap.tsx`)
- Migrated Visualization persistence to backend:
  - Removed localStorage gallery persistence (`components/VisualizationModal.tsx`)
  - Added Firestore load/save/delete integration (`components/VisualizationModal.tsx`, `services/firebaseService.ts`)
  - Added R2 upload flow for generated image/audio/video assets before save (`components/VisualizationModal.tsx`, `services/aiService.ts`, `api/upload-visualization-asset.ts`)
- Profile gallery/avatar upload remains R2 URL-based persistence (`components/UserProfilePage.tsx`, `api/upload-profile-gallery-image.ts`)
- Updated `UserProfile.gallery` semantics to URL array (`types.ts`)
- Bumped `displayVersion` to `V02.16r14` (`package.json`)
- Fixed action bar desync during map drag by syncing position on `view_data_change` (drag pan transform path) (`components/MindMap.tsx`)
- Added language fallback for action bar labels using `app_language` + `document.lang` to avoid stale English labels (`components/MindMap.tsx`)
- Bumped `displayVersion` to `V02.16r13` (`package.json`)
- Fixed action bar node anchoring so it follows selected node while map translates/zooms (`components/MindMap.tsx`)
- Hardened action bar localization by resolving labels with app language + document language fallback (`components/MindMap.tsx`)
- Bumped `displayVersion` to `V02.16r12` (`package.json`)
- Localized mind-map action bar by app language (`ko`/`en`) via `language` prop wiring (`App.tsx`, `components/MindMap.tsx`)
- Repositioned action bar to avoid node overlap by anchoring near node bounds (prefer top, fallback bottom near header) (`components/MindMap.tsx`)
- Bumped `displayVersion` to `V02.16r11` (`package.json`)
- Fixed mojibake/깨진 한글 in Visualization view UI text (`components/VisualizationModal.tsx`)
- Bumped `displayVersion` to `V02.16r10` (`package.json`)
- Locked mobile browser zoom only on GOALS tab so header/bottom dock stay fixed:
  - Added viewport meta lock/unlock effect in `App.tsx` for coarse pointer + GOALS tab only
  - Lock content: `user-scalable=no, maximum-scale=1, minimum-scale=1`
- Added map-container native gesture guards in `components/MindMap.tsx`:
  - Prevent default on multi-touch (`touchstart`/`touchmove` with 2+ touches)
  - Prevent default on iOS gesture events (`gesturestart`/`gesturechange`/`gestureend`)
- Bumped `displayVersion` to `V02.16r09` (`package.json`)
- Fixed mobile pinch zoom reliability in mind map:
  - Registered `TouchEvent` plugin for `simple-mind-map` (`components/MindMap.tsx`)
  - Expanded zoom-out floor (`minZoomRatio`/`minTouchZoomScale` to 5%)
  - Added `touchAction: 'none'` on map container to reduce gesture conflicts
- Bumped `displayVersion` to `V02.16r08` (`package.json`)
- Replaced mind-map long-press/right-click context menu with single-tap action bar (`components/MindMap.tsx`)
- Added node action bar policy by node type:
  - Non-root: `Child`, `Sibling`, `Todo`, `Generate` + `More(Insert image, Delete)`
  - Root: `Child`, `Generate`, `Insert` only
- Kept text edit entry on double-click/double-tap and wired through App edit state (`components/MindMap.tsx`, `App.tsx`)
- Added node image insert upload flow:
  - Client: hidden file input + upload handler (`App.tsx`, `services/aiService.ts`)
  - API: `POST /api/upload-node-image` with 400x400 JPEG compression and R2 upload fallback (`api/upload-node-image.ts`)
- Bumped `displayVersion` to `V02.16r07` (`package.json`)
- Image generation policy split by use-case:
  - Mind map node image: `gpt-image-1-mini` + `low` (`api/generate-image.ts`, `services/aiService.ts`)
  - Visualization image: `gpt-image-1.5` + default `medium`, optional `high` (`api/generate-image.ts`, `components/VisualizationModal.tsx`)
- Added visualization image quality toggle UI (Medium/High) (`components/VisualizationModal.tsx`)
- Bumped `displayVersion` to `V02.16r06` (`package.json`)
- Migrated AI serverless routes from Gemini to OpenAI:
  - Chat: Responses API + function tools (`api/chat.ts`)
  - Narrative: Responses API (`api/generate-narrative.ts`)
  - Images: `gpt-image-1.5` generate/edit (`api/generate-image.ts`)
  - Speech: `gpt-4o-mini-tts` PCM16 output (`api/generate-speech.ts`)
  - Video: `sora-2` job + polling (`api/generate-video.ts`, `services/aiService.ts`)
- Fixed cross-account data bleed: force reload per uid and reset in-memory state on uid change (`hooks/useAuth.ts`, `App.tsx`)
- Fixed cross-account data bleed in Visualization gallery: localStorage key is now uid-scoped + legacy key migration (`components/VisualizationModal.tsx`)
- Hardened Google login account switching: sign out before `signInWithPopup` to avoid reusing prior Firebase session (`services/firebaseService.ts`)
- Fixed account switch race: derive uid from auth callback payload (`hooks/useAuth.ts`)
- Added admin wipe script to reset Firestore goals/todos for all Auth users (`scripts/wipe-user-data.mjs`)
- Bumped `displayVersion` to `V02.16r04` (`package.json`)
- Replaced top-right text button with icon-only settings trigger in App.tsx
- Added full-screen SettingsPage.tsx for settings navigation-style flow
- Added Polar compliance checklist UI in settings (digital-only / no human service / no donation / instant access)
- Added age-based checkout readiness guard (18+ only message before payment integration)
- Moved language selector (English / Korean) into Settings page
- Reflected selected language to document.documentElement.lang
- Fixed mobile long-press context menu sizing to follow mind-map zoom scale (`components/MindMap.tsx`)
- Hardened context menu scaling on mobile by reading current zoom scale at menu-open time (`components/MindMap.tsx`)
- Fixed mobile header layout: reduced "SECRET COACH" footprint and prevented version/settings overlap (`components/MindMap.tsx`, `App.tsx`)
- Fixed mojibake/깨진 한글 UI 텍스트 in App (loading, shortcuts, sync status, delete confirm) (`App.tsx`)
- Removed Chinese placeholder text on new node creation; quick-create now creates React node and enters edit immediately (`components/MindMap.tsx`)
- Added reusable pricing calculator for OpenAI migration:
  - `pricing/pricing-config.json` (all cost assumptions and tier limits)
  - `pricing/calc-pricing.mjs` (expected/worst margin simulation)
  - `pricing/README.md` (formula + tier differentiation guide)
- Added `api/polar-webhook.ts` endpoint (initial live receiver for selected Polar events)
- Added Polar checkout API route:
  - `api/create-checkout.ts` (plan -> product mapping, checkout session creation)
- Added client billing service:
  - `services/polarService.ts` (`createPolarCheckout`, `verifyPolarCheckout`)
- Updated `SettingsPage` to show 4 plans and start checkout directly.
- Fixed runtime hook-order issue in `SettingsPage` causing React minified error #310.
- Added checkout verification API:
  - `api/verify-checkout.ts` (server-side verification by checkout_id)
- Added auto verification in `App.tsx`:
  - reads `checkout_id` from success URL query
  - calls `verifyPolarCheckout`
  - shows success/error toast and cleans URL param
- Added Firebase Admin bootstrap:
  - `lib/firebaseAdmin.ts` (server-only Firestore admin initialization)
- Upgraded Polar webhook endpoint:
  - `api/polar-webhook.ts` now verifies Standard Webhooks signature
  - syncs billing/subscription state to Firestore (`users/{uid}/billing/polar`)
  - mirrors entitlement summary to profile (`users/{uid}/profile/main`)
- Fixed Vercel runtime for webhook:
  - `api/polar-webhook.ts` imports internal module with `.js` extension (ESM)
- Added custom domain redirect:
  - `vercel.json` redirects `www.secretcoach.ai/*` -> `secretcoach.ai/*`
- Improved Polar checkout error visibility:
  - `api/create-checkout.ts` now returns `polarDetail` on 4xx/5xx for debugging
- Added legal policy pages + links:
  - Public pages: `/terms`, `/privacy`, `/refund` (served from `public/`)
  - Linked from Settings (near checkout) and LandingPage
- Webhook signature verification hardening:
  - `api/polar-webhook.ts` now supports both plain and base64 secret verification paths
  - returns 403 with missing header hints for easier debugging
- Fixed Polar webhook 403 root cause:
  - `api/polar-webhook.ts` now verifies signatures against the raw request body (stream-first)
- Version: V02.16r13
- Remaining: iOS platform add/build must be done on macOS

